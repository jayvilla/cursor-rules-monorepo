---
description: Advanced NestJS architecture, TypeORM integration, DTO validation, and Swagger documentation standards.
globs: ["apps/api/**/*.ts", "libs/api-logic/**/*.ts", "libs/shared/dto/**/*.ts"]
---
# NestJS Backend Standards (2025)

## 1. Modular Architecture
- **Structure:** One module per domain feature. Core business logic must reside in `libs/` and be imported into `apps/api/`.
- **Thin Controllers:** Controllers only handle HTTP mapping. Zero business logic allowed.
- **Fat Services:** Services handle business logic and database orchestration via TypeORM Repositories.
- **Dependency Injection:** Use constructor injection exclusively. 

## 2. DTOs & Validation
- **Strict DTOs:** Every request must have a dedicated `readonly` DTO class.
- **Validation:** Use `class-validator` decorators (e.g., `@IsString()`, `@IsOptional()`) on all DTO properties.
- **Transformation:** Ensure `ValidationPipe` is enabled in `main.ts` with `transform: true` and `whitelist: true`.
- **Sharing:** In this Nx monorepo, prefer placing DTOs in a shared library to be used by the Next.js frontend.

## 3. Swagger Documentation (OpenAPI)
- **Auto-Documentation:** Use `@ApiProperty()` on all DTO fields to ensure accurate Swagger UI generation.
- **Controller Decorators:** Use `@ApiTags()` for grouping and `@ApiOperation()`, `@ApiResponse()` (or `@ApiOkResponse()`) for endpoint documentation.
- **Type Safety:** Use `@ApiProperty({ enum: ... })` for enums to ensure the frontend client generators work correctly.

## 4. TypeORM & PostgreSQL
- **Repository Pattern:** Inject repositories using `@InjectRepository(Entity)`.
- **Entities:** Define entities in a shared `libs/data-access` library.
- **Relations:** Use `Relation<T>` for property types to avoid circular dependency issues in 2025.
- **Transactions:** Use `DataSource` or `EntityManager` for multi-entity operations.
- **Safety:** Always sanitize queries. Never use string interpolation in raw queries.

## 5. Error Handling & Responses
- **Exceptions:** Use standard `HttpException` (e.g., `NotFoundException`, `BadRequestException`).
- **Filters:** Use a global Exception Filter to ensure consistent JSON error shapes across the API.

## 6. Execution (pnpm + Nx)
- **Serve:** `pnpm nx serve api`
- **Migrations:** `pnpm nx run api:typeorm-migration-generate --name=<name>`
- **Test:** `pnpm nx test <project>` (Enforce unit tests for services).
