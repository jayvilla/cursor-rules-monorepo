---
description: Agent 7 Testing standards for Nx monorepo (NestJS API + Next.js UI).
globs:
  - "apps/api/**/*"
  - "apps/api-e2e/**/*"
  - "apps/web/**/*"
  - "apps/web-e2e/**/*"
  - "libs/**/*"
  - "**/*.spec.ts"
  - "**/*.test.ts"
  - "**/*.e2e.ts"
  - "playwright.config.*"
  - "jest.config.*"
  - "**/test/**"
  - "**/__tests__/**"
  - "docker-compose*.yml"
---
# Agent 7 — Testing Standards (Nx + pnpm, 2025)

## 1. Tooling & Command Rules
- Use **pnpm only**. Never suggest or use npm, yarn, or npx.
- All test execution MUST go through Nx:
  - API integration/e2e: `pnpm nx e2e api-e2e`
  - API unit (optional): `pnpm nx test api`
  - UI e2e/smoke: `pnpm nx e2e web-e2e`
- When executing binaries directly, use `pnpm exec <binary>` only if absolutely required.
- Dependency installation rules:
  - Workspace-level dev deps: `pnpm add -D <pkg> -w`
  - Project-scoped dev deps: `pnpm add -D <pkg> --filter <project-name>`

## 2. Testing Philosophy
- Prefer **API integration tests** (real HTTP server + real DB) over controller unit tests.
- Prefer **UI smoke tests** over exhaustive UI coverage.
- Tests must verify **observable behavior**, not implementation details.
- Avoid testing framework internals or private functions.

## 3. API Integration Testing Requirements (NestJS) — `apps/api-e2e`
- API integration tests MUST live in **`apps/api-e2e`**.
- Use **Jest + supertest**.
- Tests must spin up a **real NestJS application instance** (HTTP server).
- Tests MUST run against a **real Postgres DB** (Docker).
- Do NOT mock:
  - TypeORM repositories
  - database connections
  - HTTP layer
  - guards (unless explicitly testing guard behavior)
- Use `supertest.agent()` to preserve cookies across requests.

### Required API Coverage (in api-e2e)
- Auth:
  - Login sets an httpOnly session cookie
  - `/auth/me` returns the logged-in user
  - Logout clears the session
- CSRF:
  - Mutating requests reject missing CSRF header
  - Mutating requests accept valid CSRF cookie + `x-csrf-token`
- API key ingestion:
  - `POST /v1/audit-events` works with valid `x-api-key`
  - Invalid or missing API keys are rejected
- RBAC:
  - admin/auditor can read all org events
  - member access is restricted per business rules
- Filtering & pagination:
  - date range filt
