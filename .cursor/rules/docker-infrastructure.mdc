---
description: Docker, Docker Compose, and containerization standards for Nx, Nest.js, and PostgreSQL.
globs: ["**/Dockerfile*", "docker-compose.yml", ".dockerignore"]
---
# Docker & Infrastructure Standards (2025)

## 1. Local Development (Docker Compose)
- **Service Orchestration:** Use `docker-compose.yml` to manage the **PostgreSQL** database and any caching layers (e.g., Redis).
- **Persistent Data:** Always use named volumes for PostgreSQL data (e.g., `db_data:/var/lib/postgresql/data`) to persist data across container restarts.
- **Environment Variables:** Use an `.env` file for database credentials (`POSTGRES_USER`, `POSTGRES_PASSWORD`). Reference these in the `docker-compose` file.
- **Health Checks:** Include a `healthcheck` for the PostgreSQL service to ensure the Nest.js API only starts after the DB is ready.

## 2. Multi-Stage Dockerfiles (pnpm Optimized)
- **Base Image:** Use `node:22-alpine` (or current 2025 LTS) for small footprints.
- **pnpm Setup:** Use `corepack enable` to ensure the correct pnpm version is used inside the container.
- **Pruning:** Use a multi-stage build:
  1. **Fetch:** `pnpm fetch` to cache dependencies separately from source code.
  2. **Build:** `pnpm nx build <app-name>` to generate the production bundle.
  3. **Production:** Copy only the `dist/` and `node_modules` (pruned) to the final image.
- **Nx Focus:** Use `nx-ignore` or specific `docker context` to avoid copying the entire monorepo into every image.

## 3. Nest.js & PostgreSQL Connectivity
- **Networking:** Use the service name defined in `docker-compose` (e.g., `db-host: postgres`) as the hostname in TypeORM configuration.
- **Migrations:** Do not run migrations inside the `Dockerfile` build. Instead, suggest running them via a `command` or a dedicated "migration" container during deployment.

## 4. Security & Performance
- **Non-Root User:** Always use `USER node` in the final production stage.
- **Secrets:** Never hardcode credentials in a `Dockerfile`. Use Docker Secrets or environment variables.
- **Ignore File:** Ensure `.dockerignore` excludes `node_modules`, `.next`, `dist`, and `.git` to speed up build context transfers.

## 5. pnpm Workspace specific
- **Pruning for Apps:** In 2025, use `pnpm deploy --filter=<app-name> /prod/app` to create a self-contained directory with only the necessary dependencies for a specific Nx app before containerizing.
