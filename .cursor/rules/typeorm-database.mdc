---
description: TypeORM, PostgreSQL entities, and migration standards in an Nx + pnpm workspace.
globs: ["**/*.entity.ts", "**/migrations/*.ts", "libs/data-access-db/**/*.ts", "apps/api/**/*.ts"]
---
# TypeORM & PostgreSQL Standards (2025)

## Workspace Architecture (pnpm + Nx)
- **Centralization:** Define all `@Entity()` classes in a shared library (e.g., `libs/shared/data-access-db`) so they can be consumed by both Nest.js and migration scripts.
- **Commands:** Use `pnpm nx` to run TypeORM CLI tasks:
  - Generate: `pnpm nx run api:typeorm-migration-generate --name=AddUserTable`
  - Run: `pnpm nx run api:typeorm-migration-run`
- **Avoid Synchronize:** Never use `synchronize: true` in `data-source.ts`. Always use migrations for schema changes.

## Entity Design
- **Decorators:** Use explicit types for PostgreSQL columns (e.g., `@Column({ type: 'varchar', length: 255 })`).
- **Naming:** Use `camelCase` for TypeScript properties and `snake_case` for database columns using the `name` property: `@Column({ name: 'created_at' })`.
- **Relations:** 
  - Prefer `Relation<T>` wrapper (from TypeORM 0.3+) for circular dependencies.
  - Always specify `{ onDelete: 'CASCADE' }` or similar on `@ManyToOne` to ensure referential integrity in Postgres.
- **Base Entity:** Use a shared `BaseEntity` with `@PrimaryGeneratedColumn('uuid')`, `@CreateDateColumn()`, and `@UpdateDateColumn()`.

## Integration with Nest.js
- **Module Pattern:** Use `TypeOrmModule.forFeature([UserEntity])` in feature modules.
- **Repositories:** Use the standard `Repository<T>` injected via `@InjectRepository(T)`. Avoid custom repositories unless complex query logic is repeated in multiple services.
- **Transactions:** Use the `DataSource` or `EntityManager` to wrap multiple operations in a transaction; avoid the deprecated `@Transaction()` decorator.

## Performance & Safety
- **Postgres Specifics:** Use `@Index()` on columns frequently used in `where` clauses. Use `jsonb` for unstructured data.
- **Injection Prevention:** Never use string interpolation in `.query()`. Always use parameters: `.where("user.id = :id", { id })`.
- **Data Truncation:** Ensure `pnpm` workspace filters are used when running migrations to avoid applying changes to the wrong database environment.
